name: Deploy - Production

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check if merged PR has seed-data label
        id: check-seed-label
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.sha;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Find PRs associated with this commit
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: commitSha
            });
            
            // Also check recent merged PRs to main branch
            const mergedPRs = await github.rest.pulls.list({
              owner,
              repo,
              state: 'closed',
              base: 'main',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });
            
            let hasSeedDataLabel = false;
            
            // Check PRs associated with commit
            for (const pr of prs.data) {
              if (pr.merged_at) {
                const labels = await github.rest.issues.listLabelsOnIssue({
                  owner,
                  repo,
                  issue_number: pr.number
                });
                if (labels.data.some(label => label.name === 'seed-data')) {
                  hasSeedDataLabel = true;
                  console.log(`Found seed-data label on PR #${pr.number}`);
                  break;
                }
              }
            }
            
            // Check recent merged PRs if not found yet
            if (!hasSeedDataLabel) {
              for (const pr of mergedPRs.data) {
                if (pr.merged_at && pr.merge_commit_sha === commitSha) {
                  const labels = await github.rest.issues.listLabelsOnIssue({
                    owner,
                    repo,
                    issue_number: pr.number
                  });
                  if (labels.data.some(label => label.name === 'seed-data')) {
                    hasSeedDataLabel = true;
                    console.log(`Found seed-data label on PR #${pr.number}`);
                    break;
                  }
                }
              }
            }
            
            core.setOutput('has-seed-label', hasSeedDataLabel);
            console.log(`Seed data label found: ${hasSeedDataLabel}`);

      - name: Run database migrations
        run: pnpm db:migrate
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          GITHUB_CLIENT_ID: ${{ secrets.PRODUCTION_GITHUB_CLIENT_ID }}
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          GITHUB_CLIENT_SECRET: ${{ secrets.PRODUCTION_GITHUB_CLIENT_SECRET }}
          NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          HACKFEST_AMOUNT: ${{ secrets.HACKFEST_AMOUNT }}
          RAZORPAY_SECRET: ${{ secrets.RAZORPAY_SECRET }}
          RAZORPAY_API_KEY_ID: ${{ secrets.RAZORPAY_API_KEY_ID }}
          RAZORPAY_WEBHOOK_SECRET: ${{ secrets.RAZORPAY_WEBHOOK_SECRET }}
          NEXT_PUBLIC_RAZORPAY_API_KEY_ID: ${{ secrets.NEXT_PUBLIC_RAZORPAY_API_KEY_ID }}
        continue-on-error: false

      - name: Run database seed
        if: steps.check-seed-label.outputs.has-seed-label == 'true'
        run: pnpm db:seed
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          GITHUB_CLIENT_ID: ${{ secrets.PRODUCTION_GITHUB_CLIENT_ID }}
          MIXPANEL_TOKEN: ${{ secrets.MIXPANEL_TOKEN }}
          GITHUB_CLIENT_SECRET: ${{ secrets.PRODUCTION_GITHUB_CLIENT_SECRET }}
          NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET }}
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: ${{ secrets.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME }}
          HACKFEST_AMOUNT: ${{ secrets.HACKFEST_AMOUNT }}
          RAZORPAY_SECRET: ${{ secrets.RAZORPAY_SECRET }}
          RAZORPAY_API_KEY_ID: ${{ secrets.RAZORPAY_API_KEY_ID }}
          RAZORPAY_WEBHOOK_SECRET: ${{ secrets.RAZORPAY_WEBHOOK_SECRET }}
          NEXT_PUBLIC_RAZORPAY_API_KEY_ID: ${{ secrets.NEXT_PUBLIC_RAZORPAY_API_KEY_ID }}
        continue-on-error: false

      - name: Trigger Dokploy deployment
        run: |
          curl -X POST https://vps.finiteloop.club/api/application.deploy \
          -H 'accept: application/json' \
          -H 'Content-Type: application/json' \
          -H 'x-api-key: ${{ secrets.DOKPLOY_API_KEY }}' \
          -d '{
          "applicationId": "in8UxOnCmW2eU6HKY5Zz2"
          }'
        continue-on-error: false
